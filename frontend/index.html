<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>ä»Šå¤©åƒä»€éº¼</title>
  <style>
    body {
      font-family: system-ui;
      background: #f5f5f5;
      padding: 20px;
    }
    .card {
      background: white;
      padding: 16px;
      border-radius: 12px;
      margin-bottom: 12px;
    }
    .name {
      font-weight: bold;
      font-size: 18px;
    }
    .badge {
      font-size: 12px;
      color: #666;
    }
  </style>
</head>
<body>

<h1>ğŸ± ä»Šå¤©åƒä»€éº¼</h1>

<div>
  <label>
    <input type="radio" name="people" value="1" checked /> ä¸€å€‹äºº
  </label>
  <label>
    <input type="radio" name="people" value="2" /> å¤šäºº
  </label>
</div>

<br />
<button id="btn">å¹«æˆ‘æƒ³åƒä»€éº¼</button>

<hr />
<div id="results"></div>

<script>
  const btn = document.getElementById("btn");
  const results = document.getElementById("results");

  async function fetchRestaurants() {
    let lat = null;
    let lng = null;

    try {
      const pos = await new Promise((resolve, reject) =>
        navigator.geolocation.getCurrentPosition(resolve, reject)
      );
      lat = pos.coords.latitude;
      lng = pos.coords.longitude;
    } catch {
      console.log("ä½¿ç”¨é è¨­ä½ç½®");
    }

    const base = "https://eatwhileworking.vercel.app/api/restaurants";

    const url =
      lat && lng ? `${base}?lat=${lat}&lng=${lng}` : base;

    const res = await fetch(url);
    return { data: await res.json(), lat, lng };
  }

  function calcDistance(lat1, lon1, lat2, lon2) {
    const R = 6371;
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a =
      Math.sin(dLat / 2) ** 2 +
      Math.cos(lat1 * Math.PI / 180) *
      Math.cos(lat2 * Math.PI / 180) *
      Math.sin(dLon / 2) ** 2;

    return (R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a))).toFixed(2);
  }

  function getReason(people, type) {
    if (people === "1") return "é©åˆä¸€å€‹äººå¿«é€Ÿè§£æ±º";
    return "é©åˆå¤šäººä¸€èµ·åƒ";
  }

  btn.addEventListener("click", async () => {
    results.innerHTML = "è¼‰å…¥ä¸­â€¦";

    const people = document.querySelector(
      'input[name="people"]:checked'
    ).value;

    try {
      const { data, lat, lng } = await fetchRestaurants();

      results.innerHTML = "";

      const picks = data
        .sort(() => Math.random() - 0.5)
        .slice(0, 3);

      picks.forEach(r => {
        const distance =
          lat && lng ? calcDistance(lat, lng, r.lat, r.lng) : null;

        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <div class="name">${r.name}</div>
          <div>${r.price}</div>
          <div>${getReason(people, r.type)}</div>
          ${distance ? `<div class="badge">è·é›¢ ${distance} km</div>` : ""}
        `;
        results.appendChild(card);
      });
    } catch (err) {
      results.innerHTML = "ç™¼ç”ŸéŒ¯èª¤";
      console.error(err);
    }
  });
</script>

</body>
</html>
